<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malware Analysis Lab</title>
    <!-- Загрузка Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Стиль для чистого, профессионального интерфейса */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Roboto+Mono:wght@400&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Светло-серый фон */
            color: #1f2937; /* Темный текст */
        }
        .app-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .terminal-log {
            background-color: #1f2937; /* Темный фон для консоли */
            color: #34d399; /* Светло-зеленый текст для логов */
            overflow-y: auto;
            max-height: 200px;
            font-size: 0.85rem;
            font-family: 'Roboto Mono', monospace; /* Моноширинный шрифт для логов */
            border-radius: 0.5rem;
        }
        .log-header {
            color: #9ca3af; /* Серый заголовок лога */
        }
        /* Убираем анимацию сканирования, делаем линии простыми */
        .simple-line {
            border-top: 2px solid #3b82f6; /* Простая синяя линия */
            padding-top: 1rem;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <!-- Основной контейнер симулятора -->
    <div class="w-full max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-2">
                Malware Analysis Lab
            </h1>
            <p class="text-gray-500">
                Рабочая область: Симуляция анализа вредоносных файлов.
            </p>
        </header>

        <!-- Статус и статистика -->
        <div class="grid grid-cols-3 gap-4 mb-6 text-sm">
            <div class="app-card p-4 rounded-lg">
                <p class="text-gray-500">ВРЕМЯ АНАЛИЗА:</p>
                <p id="analysisTime" class="text-xl font-bold text-blue-600">0 с</p>
            </div>
            <div class="app-card p-4 rounded-lg">
                <p class="text-gray-500">РИСК ЗАРАЖЕНИЯ:</p>
                <p id="infectionTimer" class="text-xl font-bold text-red-600">100%</p>
            </div>
            <div class="app-card p-4 rounded-lg">
                <p class="text-gray-500">УРОВЕНЬ УГРОЗЫ:</p>
                <p id="threatLevel" class="text-xl font-bold text-green-600">LOW</p>
            </div>
        </div>

        <!-- Центральная область: Карта сети и Панель управления -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Колонка 1 & 2: Файл и Инструменты Анализа -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Карта Файла и Идентификация -->
                <div class="app-card p-6 rounded-xl relative">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 simple-line">АНАЛИЗИРУЕМЫЙ ФАЙЛ</h2>
                    <div id="fileInfo" class="grid grid-cols-2 gap-4 text-sm mb-4 text-gray-700">
                        <p>Имя Файла: <span id="fileName" class="font-medium">...</span></p>
                        <p>Индекс Угрозы: <span id="fileId" class="font-medium">#000</span></p>
                        <p>Размер (Raw): <span id="fileSize" class="font-medium">...</span></p>
                        <p>Статус: <span id="fileStatus" class="font-medium text-yellow-600">ОЖИДАНИЕ АНАЛИЗА</span></p>
                    </div>

                    <!-- Результаты статического анализа -->
                    <h3 class="font-bold mt-6 mb-2 log-header">STATIC ANALYSIS</h3>
                    <div id="staticResults" class="terminal-log p-3 mb-4">
                        <p>// R/O Access granted. No static data yet.</p>
                    </div>

                    <!-- Результаты динамического анализа -->
                    <h3 class="font-bold mb-2 log-header">DYNAMIC ANALYSIS (Behavior)</h3>
                    <div id="dynamicResults" class="terminal-log p-3">
                         <p>// Simulation not started. Execute code to see behavior.</p>
                    </div>
                </div>

                <!-- Панель Инструментов Анализа -->
                <div class="app-card p-6 rounded-xl">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">ИНСТРУМЕНТЫ ЛАБОРАТОРИИ</h2>
                    <div id="toolActions" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        <button onclick="performStaticAnalysis()" 
                                class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition disabled:opacity-50 font-semibold text-sm">
                            HEX/Strings (5s)
                        </button>
                        <button onclick="performDynamicAnalysis()" 
                                class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition disabled:opacity-50 font-semibold text-sm">
                            Run Sandbox (10s)
                        </button>
                        <button onclick="performNetworkCheck()" 
                                class="bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition disabled:opacity-50 font-semibold text-sm">
                            Network Check (8s)
                        </button>
                        <button onclick="resetLab()" id="resetButton"
                                class="bg-gray-700 text-white p-2 rounded-lg hover:bg-gray-800 transition col-span-full font-semibold">
                            ЗАГРУЗИТЬ НОВЫЙ ФАЙЛ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Колонка 3: Классификация и Миссии -->
            <div class="lg:col-span-1 space-y-6">

                <!-- Карточка Миссии -->
                <div class="app-card p-6 rounded-xl">
                    <h2 class="text-xl font-bold text-gray-800 mb-3 text-blue-600">ТЕКУЩАЯ МИССИЯ</h2>
                    <p class="text-gray-600">Цель: <span id="missionTarget" class="font-medium">Определите тип угрозы.</span></p>
                    <p class="text-gray-600 mb-4">Задача: <span id="missionDescription" class="font-medium">Классифицируйте файл до того, как риск заражения достигнет 100%.</span></p>
                </div>

                <!-- Классификация Угрозы -->
                <div class="app-card p-6 rounded-xl">
                    <h2 class="text-xl font-bold text-gray-800 mb-3 text-red-600">КЛАССИФИКАЦИЯ</h2>
                    <div id="classificationOptions" class="space-y-3">
                        <button onclick="submitClassification('RANSOMWARE')" 
                                class="w-full bg-red-100 text-red-800 p-3 rounded-lg hover:bg-red-200 transition font-medium border border-red-300">
                            RANSOMWARE
                        </button>
                        <button onclick="submitClassification('SPYWARE')" 
                                class="w-full bg-yellow-100 text-yellow-800 p-3 rounded-lg hover:bg-yellow-200 transition font-medium border border-yellow-300">
                            SPYWARE
                        </button>
                        <button onclick="submitClassification('WORM')" 
                                class="w-full bg-purple-100 text-purple-800 p-3 rounded-lg hover:bg-purple-200 transition font-medium border border-purple-300">
                            WORM / VIRUS
                        </button>
                    </div>
                </div>

                <!-- Обучающий Блок (Факт о вирусе) -->
                 <div class="app-card p-4 rounded-xl">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">ФАКТ ДНЯ</h3>
                    <p id="factDisplay" class="text-sm text-gray-600 italic">
                        ...
                    </p>
                </div>

            </div>
        </div>
    </div>

    <!-- JavaScript Game Logic (Original script is preserved) -->
    <script>
        // --- Game State and Constants ---
        let currentMalware = null;
        let analysisTime = 0;
        let infectionRisk = 0;
        let gameTimer = null;
        let hasStaticRun = false;
        let hasDynamicRun = false;
        let hasNetworkRun = false;
        
        const MAX_INFECTION_RISK = 100;
        const TIME_TO_INFECTION_FULL = 60; // 60 секунд до 100% риска (если ничего не делать)
        const ANALYSIS_TIME_COSTS = {
            STATIC: 5,
            DYNAMIC: 10,
            NETWORK: 8
        };
        const THREAT_COLORS = {
            // Updated colors for the minimalist theme
            'LOW': 'text-green-600',
            'MEDIUM': 'text-yellow-600',
            'HIGH': 'text-red-600'
        };

        // --- Malware Database (unchanged) ---
        const MALWARE_DB = [
            {
                id: 1,
                name: "encr_daemon.exe",
                type: 'RANSOMWARE',
                threatLevel: 'HIGH',
                staticHint: ['PE Header OK', 'SHA256: 0a1b2c...5d6f', 'Strings: encrypt_file, AES_KEY_GEN, .onion'],
                dynamicHint: ['Writes to Registry (HKCU\\Software\\Encrypt)', 'Attempts to change file extensions (e.g., .doc to .locked)', 'Exits gracefully after operation.'],
                networkHint: ['Single C2 connection to 10.0.0.1:443', 'Small encrypted payload sent (public key).'],
                fact: "Ransomware шифрует данные жертвы и требует выкуп. Ключевые признаки: функции шифрования и попытки изменить расширения файлов."
            },
            {
                id: 2,
                name: "sys_mon.dll",
                type: 'SPYWARE',
                threatLevel: 'MEDIUM',
                staticHint: ['PE Header OK', 'SHA256: 9e8d7c...6b5a', 'Strings: keylogger_hook, screen_capture, user_data_send'],
                dynamicHint: ['Injects code into explorer.exe', 'Monitors keyboard events (GetKeyState)', 'Captures screenshots regularly.'],
                networkHint: ['Slow, constant TCP traffic to remote host 172.16.0.5 via port 80.', 'Transfers data in small chunks.'],
                fact: "Spyware собирает информацию о пользователе (нажатиях клавиш, скриншотах) и отправляет ее злоумышленнику. Часто маскируется под DLL."
            },
            {
                id: 3,
                name: "update_patch.vbs",
                type: 'WORM',
                threatLevel: 'HIGH',
                staticHint: ['VBScript file', 'SHA256: 3f2e1d...0c9b', 'Strings: copy_self, autorun_registry, share_scan'],
                dynamicHint: ['Drops copies of itself into shared folders (network shares)', 'Creates new user account with elevated privileges', 'Attempts lateral movement to other hosts.'],
                networkHint: ['High volume of SMB (Server Message Block) traffic', 'Attempts connection to random external IPs on port 445.'],
                fact: "Worm (Червь) распространяется по сети самостоятельно, используя уязвимости или сетевые ресурсы. Ключевой признак: самокопирование и сканирование сети."
            }
        ];

        const FACTS = [
            "Самая распространенная техника распространения Ransomware — фишинговые электронные письма.",
            "WAF (Web Application Firewall) защищает от SQL-инъекций и XSS-атак.",
            "Принцип наименьших привилегий (Principle of Least Privilege) — основа кибербезопасности.",
            "Термин 'Backdoor' означает скрытый способ обхода аутентификации в системе.",
            "Фишинг часто использует поддельные домены (typosquatting) или субдомены.",
            "Брутфорс-атаки пытаются угадать пароль путем перебора всех возможных комбинаций.",
        ];


        // --- Core Game Functions ---

        /**
         * Инициализирует новую миссию/файл
         */
        function resetLab() {
            if (gameTimer) clearInterval(gameTimer);

            // Выбираем случайный файл для анализа
            const randomIndex = Math.floor(Math.random() * MALWARE_DB.length);
            currentMalware = MALWARE_DB[randomIndex];

            // Сброс состояния
            analysisTime = 0;
            infectionRisk = 0;
            hasStaticRun = false;
            hasDynamicRun = false;
            hasNetworkRun = false;

            // Обновление UI
            document.getElementById('fileName').textContent = currentMalware.name;
            document.getElementById('fileId').textContent = `#${currentMalware.id.toString().padStart(3, '0')}`;
            document.getElementById('fileSize').textContent = `${(Math.random() * 10 + 0.5).toFixed(2)} KB`;
            document.getElementById('fileStatus').textContent = 'В ОЧЕРЕДИ';
            
            // Используем классы из THREAT_COLORS
            document.getElementById('threatLevel').className = `text-xl font-bold ${THREAT_COLORS[currentMalware.threatLevel]}`;
            document.getElementById('threatLevel').textContent = currentMalware.threatLevel;

            document.getElementById('staticResults').innerHTML = '<p class="text-gray-400">// R/O Access granted. No static data yet.</p>';
            document.getElementById('dynamicResults').innerHTML = '<p class="text-gray-400">// Simulation not started. Execute code to see behavior.</p>';
            document.getElementById('factDisplay').textContent = FACTS[Math.floor(Math.random() * FACTS.length)];
            
            enableTools(true);
            updateStats();
            logMessage(`New File '${currentMalware.name}' loaded. Start analysis now!`, 'system');

            // Запуск таймера
            gameTimer = setInterval(tick, 1000);
        }

        /**
         * Игровой цикл (вызывается каждую секунду)
         */
        function tick() {
            // Если анализ еще не начат, риск растет
            if (analysisTime < 5) {
                // Если мы ничего не делаем, риск заражения растет
                infectionRisk += (100 / TIME_TO_INFECTION_FULL);
            } else {
                // Если анализ идет, риск замедляется
                infectionRisk += (100 / (TIME_TO_INFECTION_FULL * 2)); 
            }

            // Минимальный рост риска
            if (infectionRisk >= MAX_INFECTION_RISK) {
                gameOver(false);
                return;
            }

            updateStats();
        }

        /**
         * Обновляет все отображаемые статистики
         */
        function updateStats() {
            document.getElementById('analysisTime').textContent = `${analysisTime} s`;
            const riskValue = Math.min(MAX_INFECTION_RISK, infectionRisk).toFixed(1);
            document.getElementById('infectionTimer').textContent = `${riskValue}%`;
            
            // Цветовая индикация риска (обновлено для минимализма)
            let color;
            if (riskValue > 80) {
                color = 'text-red-600';
            } else if (riskValue > 50) {
                color = 'text-orange-500';
            } else {
                color = 'text-green-600';
            }
            document.getElementById('infectionTimer').className = `text-xl font-bold ${color}`;
        }

        /**
         * Добавляет сообщение в консоль логов.
         */
        function logMessage(message, type) {
            // Выводим системные сообщения в console.log, чтобы не перегружать UI
            const color = type === 'success' ? 'green' : type === 'error' ? 'red' : 'blue';
            console.log(`%c[Log] ${message}`, `color: ${color};`);
            
            // Добавляем запись в лог статического анализа (как общий терминал)
            const consoleEl = document.getElementById('staticResults');
            const logEntry = document.createElement('p');
            
            // Обновленные цвета логов для терминала
            let logColor = 'text-green-400'; 
            if (type === 'system') logColor = 'text-blue-400';
            if (type === 'error') logColor = 'text-red-400';
            
            logEntry.className = logColor;
            logEntry.innerHTML = `> ${message}`;
            
            consoleEl.appendChild(logEntry);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }
        
        /**
         * Включает/выключает кнопки инструментов
         */
        function enableTools(enable) {
            const buttons = document.querySelectorAll('#toolActions button:not(#resetButton)');
            buttons.forEach(btn => btn.disabled = !enable);
        }

        /**
         * Функция для обработки задержки действия
         * @param {number} timeCost - Стоимость времени
         * @param {function} callback - Функция, которую нужно выполнить
         */
        function delayAction(timeCost, callback) {
            enableTools(false);
            analysisTime += timeCost;
            logMessage(`Executing operation (${timeCost}s delay)...`, 'system');

            // Имитация задержки
            setTimeout(() => {
                callback();
                enableTools(true);
            }, 1000); // Реальная задержка 1 секунда для UI, но время анализа учитывается
        }

        // --- Analysis Tools ---

        function performStaticAnalysis() {
            if (hasStaticRun) { logMessage("Static Analysis already performed.", 'system'); return; }
            hasStaticRun = true;

            delayAction(ANALYSIS_TIME_COSTS.STATIC, () => {
                const resultsEl = document.getElementById('staticResults');
                resultsEl.innerHTML = '<p class="text-blue-400">// STATIC ANALYSIS RESULTS</p>';
                
                currentMalware.staticHint.forEach(hint => {
                    resultsEl.innerHTML += `<p class="text-white">| ${hint}</p>`;
                });
                
                document.getElementById('fileStatus').textContent = 'STATIC DATA ACQUIRED';
                logMessage('Static analysis completed. Check Hex/Strings for clues.', 'success');
            });
        }

        function performDynamicAnalysis() {
            if (hasDynamicRun) { logMessage("Dynamic Analysis already performed.", 'system'); return; }
            hasDynamicRun = true;

            delayAction(ANALYSIS_TIME_COSTS.DYNAMIC, () => {
                const resultsEl = document.getElementById('dynamicResults');
                resultsEl.innerHTML = '<p class="text-blue-400">// SANDBOX EXECUTION LOG</p>';

                currentMalware.dynamicHint.forEach(hint => {
                    resultsEl.innerHTML += `<p class="text-white">| [BEHAVIOR] ${hint}</p>`;
                });
                
                document.getElementById('fileStatus').textContent = 'DYNAMIC DATA ACQUIRED';
                logMessage('Dynamic analysis completed. Observed file behavior.', 'success');
            });
        }
        
        function performNetworkCheck() {
            if (hasNetworkRun) { logMessage("Network Check already performed.", 'system'); return; }
            hasNetworkRun = true;

            delayAction(ANALYSIS_TIME_COSTS.NETWORK, () => {
                const resultsEl = document.getElementById('dynamicResults');
                resultsEl.innerHTML += '<p class="text-yellow-400">// NETWORK TRAFFIC LOG</p>';

                currentMalware.networkHint.forEach(hint => {
                    resultsEl.innerHTML += `<p class="text-yellow-400">| [NET] ${hint}</p>`;
                });
                
                document.getElementById('fileStatus').textContent = 'NETWORK DATA ACQUIRED';
                logMessage('Network check completed. Traffic patterns logged.', 'success');
            });
        }

        // --- Classification and Game End ---

        function submitClassification(guess) {
            if (!currentMalware || !gameTimer) {
                 logMessage("Error: No active file.", 'error');
                 return;
            }

            if (!hasStaticRun || !hasDynamicRun) {
                 logMessage("Error: Perform STATIC and DYNAMIC analysis before final classification!", 'error');
                 return;
            }

            if (guess === currentMalware.type) {
                gameOver(true, guess);
            } else {
                // Штраф за неправильную догадку
                infectionRisk += 15;
                logMessage(`Classification attempt failed! '${guess}' is incorrect. +15% Risk Penalty.`, 'error');
                updateStats();
            }
        }
        
        /**
         * Завершает игру
         * @param {boolean} success - Успешно ли завершена миссия
         * @param {string} type - Тип угрозы (если успех)
         */
        function gameOver(success, type = 'UNKNOWN') {
            if (gameTimer) clearInterval(gameTimer);
            gameTimer = null;
            
            enableTools(false);
            
            let message = '';
            let color = '';

            if (success) {
                const finalScore = (MAX_INFECTION_RISK - infectionRisk) * 10 + (1000 - analysisTime * 5);
                message = `[MISSION SUCCESS] File classified as ${type}! Risk neutralized. Final Score: ${Math.max(0, finalScore.toFixed(0))}.`;
                color = 'text-green-600';
            } else {
                message = `[MISSION FAILED] Infection Risk reached 100%. File was a ${currentMalware.type}. Restart to try again.`;
                color = 'text-red-600';
            }
            
            logMessage(`--- GAME OVER ---`, 'system');
            logMessage(message, success ? 'success' : 'error');
            
            document.getElementById('fileStatus').innerHTML = `<span class="${color}">${success ? 'NEUTRALIZED' : 'INFECTED'}</span>`;
        }


        // --- Initialization ---
        window.onload = resetLab;

    </script>
</body>
</html>
